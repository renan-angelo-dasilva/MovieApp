# Movie Catalog API - Architecture Documentation

## System Architecture

### High-Level Architecture

```
???????????????????????????????????????????????????????????????
?                     Client Applications                      ?
?  (Web Browser, Mobile App, Desktop App, API Consumers)      ?
???????????????????????????????????????????????????????????????
                         ?
                         ? HTTP/HTTPS
                         ?
???????????????????????????????????????????????????????????????
?                  Movie Catalog API (.NET 8)                  ?
?                                                               ?
?  ????????????????????????????????????????????????????????   ?
?  ?              Presentation Layer                       ?   ?
?  ?  • Minimal API Endpoints (MovieEndpoints.cs)         ?   ?
?  ?  • Request/Response DTOs                             ?   ?
?  ?  • Input Validation (FluentValidation)              ?   ?
?  ?  • Swagger/OpenAPI Documentation                     ?   ?
?  ????????????????????????????????????????????????????????   ?
?                       ?                                       ?
?  ????????????????????????????????????????????????????????   ?
?  ?              Service Layer                            ?   ?
?  ?  • MovieService (CRUD operations)                    ?   ?
?  ?  • MovieRecommendationService (AI-powered)           ?   ?
?  ?  • Business Logic                                    ?   ?
?  ?  • Channel-based Streaming                           ?   ?
?  ????????????????????????????????????????????????????????   ?
?                       ?                                       ?
?  ????????????????????????????????????????????????????????   ?
?  ?              Data Access Layer                        ?   ?
?  ?  • MovieDbContext (Entity Framework Core)            ?   ?
?  ?  • Repository Pattern (via EF Core)                  ?   ?
?  ?  • In-Memory Database (Demo)                         ?   ?
?  ????????????????????????????????????????????????????????   ?
?                                                               ?
?  ?????????????????????????????????????????????????????????  ?
?  ?           External Integrations                        ?  ?
?  ?  • Semantic Kernel (AI Orchestration)                 ?  ?
?  ?  • OpenAI API (GPT Models)                            ?  ?
?  ?????????????????????????????????????????????????????????  ?
?????????????????????????????????????????????????????????????????
```

## Component Details

### 1. Presentation Layer

**Endpoints (MovieEndpoints.cs)**
- Maps HTTP routes to service methods
- Handles request/response formatting
- Manages HTTP status codes
- Implements Server-Sent Events (SSE) for streaming

**DTOs (Data Transfer Objects)**
- `CreateMovieDto`: Input for creating movies
- `UpdateMovieDto`: Input for updating movies (partial)
- `MovieResponseDto`: Output format for movie data
- `MovieRecommendationRequest`: Input for recommendation requests
- `MovieRecommendationResponse`: Output with AI recommendations

**Validators**
- `CreateMovieDtoValidator`: Validates movie creation requests
- `UpdateMovieDtoValidator`: Validates movie update requests
- Uses FluentValidation for declarative validation rules

### 2. Service Layer

**IMovieService & MovieService**
```
???????????????????????????????????
?      MovieService               ?
???????????????????????????????????
? + GetByIdAsync()                ?
? + GetAllAsync()                 ?
? + GetByCategoryAsync()          ?
? + CreateAsync()                 ?
? + UpdateAsync()                 ?
? + DeleteAsync()                 ?
? + StreamMoviesByCategoryAsync() ?
???????????????????????????????????
```

**Features:**
- Async/await throughout
- No-tracking queries for read operations
- Efficient data mapping
- Channel-based streaming

**IMovieRecommendationService & MovieRecommendationService**
```
??????????????????????????????????????
?  MovieRecommendationService        ?
??????????????????????????????????????
? + GetRecommendationsAsync()        ?
? - BuildMovieCatalog()              ?
? - ParseAIResponse()                ?
? - GetFallbackRecommendations()     ?
??????????????????????????????????????
```

**Features:**
- AI-powered recommendations using Semantic Kernel
- Age-based filtering
- Fallback to logic-based recommendations
- Intelligent parsing of AI responses

### 3. Data Layer

**MovieDbContext**
```
???????????????????????????????????
?      MovieDbContext             ?
???????????????????????????????????
? DbSet<Movie> Movies             ?
???????????????????????????????????
? + OnModelCreating()             ?
?   - Indexes on Category, Year   ?
?   - String length constraints   ?
?   - Seed data                   ?
???????????????????????????????????
```

**Movie Entity**
```
???????????????????????????????????
?           Movie                 ?
???????????????????????????????????
? + Id: int                       ?
? + Title: string                 ?
? + Description: string           ?
? + Category: string              ?
? + ReleaseYear: int              ?
? + Rating: double                ?
? + MinimumAge: int               ?
? + Director: string?             ?
? + Cast: List<string>            ?
? + DurationMinutes: int          ?
? + CreatedAt: DateTime           ?
? + UpdatedAt: DateTime           ?
???????????????????????????????????
```

## Data Flow Diagrams

### Create Movie Flow
```
Client Request
    ?
    ? POST /api/movies
    ? CreateMovieDto
    ?
    ?
MovieEndpoints
    ?
    ? Validate with FluentValidation
    ?
    ?
MovieService.CreateAsync()
    ?
    ? Map DTO to Entity
    ?
    ?
MovieDbContext
    ?
    ? SaveChangesAsync()
    ?
    ?
Database (In-Memory)
    ?
    ?
Return MovieResponseDto
```

### AI Recommendation Flow
```
Client Request
    ?
    ? POST /api/movies/recommendations
    ? { userAge: 15 }
    ?
    ?
MovieEndpoints
    ?
    ?
MovieRecommendationService
    ?
    ??????????????????????????????????????????????
    ?                      ?                     ?
GetAllMovies()    BuildCatalog()      FilterByAge()
    ?                      ?                     ?
    ?                      ?                     ?
MovieService              ?                     ?
    ?                      ?                     ?
    ?                      ?                     ?
MovieDbContext    ??????????????????   Age Filter Logic
                  ? Semantic Kernel?
                  ?                ?
                  ? ?????????????? ?
                  ? ?  OpenAI    ? ?
                  ? ?  GPT-3.5   ? ?
                  ? ?????????????? ?
                  ?                ?
                  ? AI Processing  ?
                  ??????????????????
                          ?
                          ?
                  Parse AI Response
                          ?
                          ?
            Return Recommended Movies + Reasoning
```

### Streaming Flow (Channels)
```
Client Request (SSE)
    ?
    ? GET /api/movies/category/Action/stream
    ?
    ?
MovieEndpoints
    ?
    ?
MovieService.StreamMoviesByCategoryAsync()
    ?
    ?
Create Unbounded Channel
    ?
    ??????????????????????????????????????????????
    ?                     ?                      ?
    ?              Background Task          Channel Writer
    ?                     ?                      ?
    ?              Query Database               ?
    ?                     ?                      ?
    ?                     ?                      ?
    ?              For each movie ????????????????
    ?                                            ?
    ?                                      Write to Channel
    ?                                            ?
    ?                                            ?
Channel Reader ???????????????????????????? Channel Writer
    ?
    ? ReadAllAsync()
    ?
    ?
Stream to Client (SSE)
```

## Technology Stack

### Core Framework
- **.NET 8**: Latest LTS version with performance improvements
- **ASP.NET Core Minimal APIs**: Lightweight, high-performance endpoints
- **C# 12**: Latest language features

### Database
- **Entity Framework Core 8.0**: ORM with excellent performance
- **In-Memory Database**: For demo/testing (easily replaceable)

### AI/ML
- **Microsoft Semantic Kernel**: AI orchestration framework
- **OpenAI API**: GPT models for intelligent recommendations

### Validation & Documentation
- **FluentValidation 11.x**: Declarative validation rules
- **Swashbuckle (Swagger)**: OpenAPI documentation

### Performance Features
- **System.Threading.Channels**: High-performance async streaming
- **Async/Await**: Non-blocking I/O throughout
- **AsNoTracking**: Read-only query optimization
- **Connection Pooling**: Automatic database connection management

## Design Patterns

### 1. Repository Pattern
Implemented via Entity Framework Core DbContext

### 2. Dependency Injection
All services registered in DI container

### 3. DTOs (Data Transfer Objects)
Clean separation between domain and API contracts

### 4. Service Layer Pattern
Business logic isolated from presentation

### 5. Strategy Pattern
AI recommendations with fallback strategies

### 6. Producer-Consumer Pattern
Channel-based streaming implementation

## Performance Optimizations

### Database
```csharp
// Indexes on frequently queried columns
entity.HasIndex(e => e.Category);
entity.HasIndex(e => e.ReleaseYear);

// No-tracking for read-only queries
.AsNoTracking()

// Async operations
await _context.SaveChangesAsync(cancellationToken);
```

### Streaming
```csharp
// Unbounded channels for high throughput
var channel = Channel.CreateUnbounded<MovieResponseDto>();

// Background processing
_ = Task.Run(async () => { ... });

// Efficient enumeration
await foreach (var movie in movies.WithCancellation(ct))
```

### Validation
```csharp
// Early validation before processing
var validationResult = await validator.ValidateAsync(dto, ct);
if (!validationResult.IsValid)
    return Results.ValidationProblem(validationResult.ToDictionary());
```

## Security Considerations

### Current Implementation
- CORS configured for development
- Input validation on all endpoints
- No authentication (demo application)

### Production Recommendations
1. **Authentication & Authorization**
   - JWT tokens
   - OAuth 2.0 / OpenID Connect
   - Role-based access control

2. **API Security**
   - API key validation
   - Rate limiting
   - Request throttling

3. **Data Protection**
   - Encrypt sensitive data
   - Secure API keys (User Secrets, Key Vault)
   - HTTPS enforcement

4. **Input Validation**
   - Already implemented with FluentValidation
   - SQL injection prevention via EF Core

## Scalability Considerations

### Current Design
- Stateless API (horizontally scalable)
- In-memory database (not production-ready)
- No caching layer

### Scaling Recommendations

1. **Database**
   - Replace in-memory with SQL Server/PostgreSQL
   - Implement read replicas
   - Use connection pooling (already configured)

2. **Caching**
   - Add Redis for response caching
   - Cache AI recommendations
   - Cache category queries

3. **Load Balancing**
   - Deploy behind load balancer
   - Use health check endpoint
   - Implement graceful shutdown

4. **Async Processing**
   - Message queue for batch operations
   - Background jobs for heavy processing

## Monitoring & Observability

### Logging
```csharp
_logger.LogInformation("Created movie {MovieId}: {MovieTitle}", 
    movie.Id, movie.Title);
```

### Health Checks
```
GET /health
```

### Production Additions
- Application Insights
- Distributed tracing
- Performance metrics
- Error tracking

## Testing Strategy

### Unit Tests
- Service layer logic
- Validators
- DTO mapping

### Integration Tests
- API endpoints
- Database operations
- AI service integration

### Performance Tests
- Load testing
- Stress testing
- Streaming performance

## Deployment Options

### 1. Azure App Service
- Easy deployment
- Auto-scaling
- Managed service

### 2. Docker Container
- Dockerfile included
- Container-based deployment
- Kubernetes support

### 3. Self-Hosted
- IIS
- Nginx reverse proxy
- Windows Service

## Future Enhancements

1. **GraphQL Support**: Alternative to REST
2. **gRPC Endpoints**: High-performance RPC
3. **SignalR**: Real-time bidirectional communication
4. **Event Sourcing**: Audit trail of all changes
5. **CQRS**: Separate read and write models
6. **Multi-tenancy**: Support multiple catalogs
7. **Advanced Search**: Full-text search with Elasticsearch
8. **Image Management**: Movie poster uploads
9. **User Ratings**: User-generated ratings and reviews
10. **Recommendation ML**: Custom ML models

---

This architecture provides a solid foundation for a production-ready movie catalog API with room for growth and enhancement.
